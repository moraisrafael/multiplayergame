<html>

<head>
    <meta charset="utf-8">
    <title>My first multiplayer game</title>
    <style>
        #screen {
            border: 10px solid #CCC;
            image-rendering: pixelated;
            image-rendering: crisp-edges;
            image-rendering: -moz-crisp-edges;
            width: 400px;
            height: 400px;
        }
    </style>
    <script src="/socket.io/socket.io.js"></script>
</head>

<body>
    <h1>My first multiplayer game</h1>
    <canvas id="screen" width="10" height="10"></canvas>
    <script type="module">
        import createKeyboardListener from './keyboardListener.js';
        import createGame from './game.js'
        import renderScreen from './renderScreen.js'

        let playerId = "";

        const game = createGame();
        export default game;


        const screen = document.getElementById('screen');

        const socket = io();

        socket.on('connect', () => {
            playerId = socket.id;
            console.log(`Player connected on Client with id ${playerId}`);
            
            renderScreen(screen, game, playerId);
        })

        socket.on('setup', (state) => {
            game.setState(state);
        })

        socket.on('stateChange', (command) => {
            if (!command.playerId || command.playerId != playerId) {
                game[command.type](command);
            }
        })

        const keyboardListener = createKeyboardListener();

        keyboardListener.subscribe((command) => {
            game.movePlayer({
                playerId: playerId, keyPressed: command.keyPressed
            })
        });

        keyboardListener.subscribe((command) => {
            socket.emit('movePlayer', command);
        });
    </script>
</body>

</html>